// Prisma schema for VuAppStore - Stripe-compliant subscription model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model with clear business records for Stripe compliance
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Clear subscription relationship
  subscriptions Subscription[]
  
  // Compliance fields - TOS acceptance
  tosAcceptedAt DateTime?
  tosAcceptedIp String?
  tosVersion    String?   // Track which version of TOS was accepted
  
  // Privacy compliance
  gdprConsent   Boolean   @default(false)
  ccpaOptOut    Boolean   @default(false)
  marketingConsent Boolean @default(false)
  
  // Support history for dispute prevention
  supportTickets SupportTicket[]
  
  // Download history for re-downloads
  downloads Download[]
  
  // Account status
  status    String   @default("active") // active, suspended, deleted
  deletedAt DateTime?
  
  @@index([email])
  @@index([status])
}

// Clear subscription model for Stripe
model Subscription {
  id               String   @id @default(cuid())
  userId           String
  stripeCustomerId String   // Stripe customer ID
  stripeSubscriptionId String? @unique // Stripe subscription ID
  stripePriceId    String   // Stripe price ID
  
  // Subscription details
  plan             String   // monthly, annual, lifetime
  status           String   // active, cancelled, past_due, unpaid
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt        DateTime?
  cancelReason       String?
  
  // Clear audit trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Invoices for this subscription
  invoices Invoice[]
  
  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
}

// Invoice records for transparency and dispute prevention
model Invoice {
  id                String   @id @default(cuid())
  subscriptionId    String
  stripeInvoiceId   String   @unique
  
  // Invoice details
  amount            Int      // Amount in cents
  currency          String   @default("usd")
  status            String   // paid, open, void, uncollectible
  
  // Payment details
  paidAt            DateTime?
  paymentMethod     String?  // card, paypal, etc.
  
  // Billing period
  periodStart       DateTime
  periodEnd         DateTime
  
  // Audit trail
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([status])
}

// Support ticket system for dispute prevention
model SupportTicket {
  id        String   @id @default(cuid())
  userId    String
  
  // Ticket details
  subject   String
  status    String   @default("open") // open, in_progress, resolved, closed
  priority  String   @default("medium") // low, medium, high, urgent
  category  String?  // billing, technical, refund, account
  
  // Resolution
  createdAt  DateTime @default(now())
  resolvedAt DateTime?
  closedAt   DateTime?
  
  // Metadata
  metadata   Json?    // Store additional context
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages TicketMessage[]
  
  @@index([userId])
  @@index([status])
  @@index([priority])
}

// Support ticket messages
model TicketMessage {
  id       String   @id @default(cuid())
  ticketId String
  
  // Message details
  content  String   @db.Text
  isStaff  Boolean  @default(false)
  author   String   // Email or staff ID
  
  // Timestamps
  createdAt DateTime @default(now())
  
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
}

// Download history for user convenience and analytics
model Download {
  id       String   @id @default(cuid())
  userId   String
  appId    String   // Reference to app slug
  
  // Download details
  version  String?
  platform String   // windows, macos, linux, ios, android
  
  // Timestamp
  downloadedAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([appId])
}

// Refund tracking for Stripe compliance
model Refund {
  id              String   @id @default(cuid())
  stripeRefundId  String   @unique
  invoiceId       String
  
  // Refund details
  amount          Int      // Amount in cents
  reason          String?  // customer_request, duplicate, fraudulent
  status          String   // pending, succeeded, failed, cancelled
  
  // Timestamps
  createdAt       DateTime @default(now())
  processedAt     DateTime?
  
  @@index([invoiceId])
  @@index([status])
}

// Privacy compliance log
model PrivacyRequest {
  id         String   @id @default(cuid())
  userId     String?
  email      String
  
  // Request details
  type       String   // access, deletion, correction, export
  status     String   @default("pending") // pending, processing, completed, rejected
  reason     String?
  
  // Processing
  createdAt   DateTime @default(now())
  processedAt DateTime?
  completedAt DateTime?
  
  // Metadata
  metadata    Json?
  
  @@index([email])
  @@index([status])
}

// Audit log for compliance
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  
  // Event details
  action     String   // user.created, subscription.updated, refund.requested, etc.
  resource   String?  // Resource type
  resourceId String?  // Resource ID
  
  // Details
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  
  // Timestamp
  createdAt  DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

